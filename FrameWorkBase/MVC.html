<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MVC原理 | 小陈小陈，心想事成</title>
    <meta name="description" content="一本正经的学习">
    
    
    <link rel="preload" href="/assets/css/0.styles.9b57bccc.css" as="style"><link rel="preload" href="/assets/js/app.1ae9d9f8.js" as="script"><link rel="preload" href="/assets/js/2.854a77d5.js" as="script"><link rel="preload" href="/assets/js/24.895485da.js" as="script"><link rel="prefetch" href="/assets/js/10.117b2710.js"><link rel="prefetch" href="/assets/js/11.62f8bcdd.js"><link rel="prefetch" href="/assets/js/12.fd2bb82d.js"><link rel="prefetch" href="/assets/js/13.72ebf73a.js"><link rel="prefetch" href="/assets/js/14.e479313e.js"><link rel="prefetch" href="/assets/js/15.d7c1ffa3.js"><link rel="prefetch" href="/assets/js/16.8a3dafd4.js"><link rel="prefetch" href="/assets/js/17.6738bee5.js"><link rel="prefetch" href="/assets/js/18.c14cf9c6.js"><link rel="prefetch" href="/assets/js/19.40e5a969.js"><link rel="prefetch" href="/assets/js/20.b20a9aef.js"><link rel="prefetch" href="/assets/js/21.644273f6.js"><link rel="prefetch" href="/assets/js/22.22b3d770.js"><link rel="prefetch" href="/assets/js/23.01402885.js"><link rel="prefetch" href="/assets/js/25.e364caee.js"><link rel="prefetch" href="/assets/js/26.da31edd3.js"><link rel="prefetch" href="/assets/js/27.59fff129.js"><link rel="prefetch" href="/assets/js/28.46361883.js"><link rel="prefetch" href="/assets/js/29.329d5acb.js"><link rel="prefetch" href="/assets/js/3.8e9d119f.js"><link rel="prefetch" href="/assets/js/30.452b4f31.js"><link rel="prefetch" href="/assets/js/31.d2eee2c2.js"><link rel="prefetch" href="/assets/js/32.bc4e371a.js"><link rel="prefetch" href="/assets/js/33.101f90b2.js"><link rel="prefetch" href="/assets/js/34.ee8fd077.js"><link rel="prefetch" href="/assets/js/35.d8b31fca.js"><link rel="prefetch" href="/assets/js/36.99eb1472.js"><link rel="prefetch" href="/assets/js/37.280958f5.js"><link rel="prefetch" href="/assets/js/38.c226c526.js"><link rel="prefetch" href="/assets/js/39.f275d26b.js"><link rel="prefetch" href="/assets/js/4.ce340b11.js"><link rel="prefetch" href="/assets/js/40.68910ab2.js"><link rel="prefetch" href="/assets/js/41.2c66f197.js"><link rel="prefetch" href="/assets/js/42.4ef930d0.js"><link rel="prefetch" href="/assets/js/43.edeb60a1.js"><link rel="prefetch" href="/assets/js/44.5c5e4fd2.js"><link rel="prefetch" href="/assets/js/45.b0bc7ef8.js"><link rel="prefetch" href="/assets/js/46.8b2aac91.js"><link rel="prefetch" href="/assets/js/47.45469b48.js"><link rel="prefetch" href="/assets/js/48.804fac29.js"><link rel="prefetch" href="/assets/js/5.8b784284.js"><link rel="prefetch" href="/assets/js/6.d5340385.js"><link rel="prefetch" href="/assets/js/7.d6b3c5de.js"><link rel="prefetch" href="/assets/js/8.a4315874.js"><link rel="prefetch" href="/assets/js/9.7c808697.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9b57bccc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小陈小陈，心想事成</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">前端</a></div><div class="nav-item"><a href="/nav/Time.html" class="nav-link">时间安排</a></div><div class="nav-item"><a href="/nav/Reading.html" class="nav-link">阅读</a></div><div class="nav-item"><a href="/nav/MY.html" class="nav-link">作品</a></div><div class="nav-item"><a href="https://github.com/jeryqwq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">前端</a></div><div class="nav-item"><a href="/nav/Time.html" class="nav-link">时间安排</a></div><div class="nav-item"><a href="/nav/Reading.html" class="nav-link">阅读</a></div><div class="nav-item"><a href="/nav/MY.html" class="nav-link">作品</a></div><div class="nav-item"><a href="https://github.com/jeryqwq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS深入系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>框架必知</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FrameWorkBase/MVVM.html" class="sidebar-link">MVVM响应式原理</a></li><li><a href="/FrameWorkBase/MVC.html" class="active sidebar-link">MVC原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FrameWorkBase/MVC.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/FrameWorkBase/MVC.html#react原理分析" class="sidebar-link">React原理分析</a></li><li class="sidebar-sub-header"><a href="/FrameWorkBase/MVC.html#简易实现react" class="sidebar-link">简易实现React</a></li><li class="sidebar-sub-header"><a href="/FrameWorkBase/MVC.html#实现效果预览" class="sidebar-link">实现效果预览</a></li></ul></li><li><a href="/FrameWorkBase/VisualDom.html" class="sidebar-link">虚拟DOM</a></li><li><a href="/FrameWorkBase/DomDiff.html" class="sidebar-link">Diff算法</a></li><li><a href="/FrameWorkBase/reactRoute.html" class="sidebar-link">路由-React</a></li><li><a href="/FrameWorkBase/VueRouter.html" class="sidebar-link">路由-Vue</a></li><li><a href="/FrameWorkBase/reactPublicState.html" class="sidebar-link">状态管理-React</a></li><li><a href="/FrameWorkBase/VueState.html" class="sidebar-link">状态管理-Vue</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端大杂烩</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三大浪漫</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>本次仅针对React 15.8之前的代码原理解析说明，忽略fiber，事务机制，时间分片等底层操作，仅根据原理实现react基础的核心思想</p> <h2 id="react原理分析"><a href="#react原理分析" class="header-anchor">#</a> React原理分析</h2> <h3 id="jsx"><a href="#jsx" class="header-anchor">#</a> JSX:</h3> <p>react中所有的类似html代码到最终都会被<a href="https://www.babeljs.cn/" target="_blank" rel="noopener noreferrer">babel<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>编译为createElement的形式,<a href="https://jeryqwq.github.io/FrameWorkBase/VisualDom.html" target="_blank" rel="noopener noreferrer">createElement实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>a<span class="token operator">&gt;</span>
  	target
  <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
使用babel编译后<span class="token operator">:</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;target&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="组件"><a href="#组件" class="header-anchor">#</a> 组件:</h3> <p>在React中，组件分为两种，即函数组件和类组件。
我们来看看函数式组件，babel会编译成什么样子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> name<span class="token operator">=</span><span class="token string">&quot;CJ&quot;</span><span class="token punctuation">;</span>
  	<span class="token keyword">return</span><span class="token punctuation">(</span>
      	<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        	<span class="token punctuation">{</span>name<span class="token punctuation">}</span> 		
      	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span> 
      <span class="token punctuation">)</span> 	 
<span class="token punctuation">}</span>
babel编译后：
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">&quot;CJ&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//这样就能很好的解释为什么return内含的变量和函数能够被渲染和执行</span>
</code></pre></div><p>我们来看看更复杂的函数组件，含有map遍历和传递参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> name<span class="token operator">=</span><span class="token string">&quot;CJ&quot;</span><span class="token punctuation">;</span>
  	<span class="token keyword">return</span><span class="token punctuation">(</span>
      	<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>idx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>
        <span class="token operator">&lt;</span>div name<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        	<span class="token punctuation">{</span>name<span class="token punctuation">}</span> 		
      	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span> 
       	<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
babel编译后：
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">&quot;CJ&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//循环渲染五个div</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> name<span class="token comment">//节点props</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> name<span class="token comment">/*子节点的内容*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看看比较复杂的类组件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//es6 接收参数</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{name:'CJ'}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token punctuation">{</span>
			name<span class="token operator">:</span><span class="token string">'CJ'</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span><span class="token punctuation">(</span><span class="token comment">//编译为createElement渲染</span>
				<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
				<span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span>
				<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
	<span class="token operator">&lt;</span>Test name<span class="token operator">=</span><span class="token string">'CJ'</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token comment">//渲染改类的render函数，等同于new Test({name:'CJ'}).render()</span>
	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'example'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//等同于</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
	<span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'CJ'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//渲染时调用实例化后该函数的render方法</span>
	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'example'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>函数组件就比较简单了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Test</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token operator">=</span><span class="token string">&quot;CJ&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
	<span class="token operator">&lt;</span>Test name<span class="token operator">=</span><span class="token string">&quot;CJ&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token comment">//直接运行函数即可渲染</span>
	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'example'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//等同于</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'CJ'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'example'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看出，无论是函数组件，还是类组件，返回的都是React.createElement的格式，第一个参数可以是多个类型,可以是指向虚拟DOM的变量，也可以是一个类组件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> El<span class="token operator">=</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token number">123</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token comment">//babel:转换后</span>
<span class="token keyword">var</span> El <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Ell <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>El<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="简易实现react"><a href="#简易实现react" class="header-anchor">#</a> 简易实现React</h2> <p>基于上面这些特性，我们就能写出一个拥有上述功能的的react。</p> <h3 id="文件描述"><a href="#文件描述" class="header-anchor">#</a> 文件描述</h3> <p>使用webpack(ESModul语法)构建,自行手动搭建好webpack运行环境。</p> <blockquote><p>react 文件夹</p></blockquote> <ul><li>index.js   //import入口文件，提供React基础API,React.render,React.Component,React.createElement</li> <li>addEvent.js //实现事件委托功能，使用发布订阅在节点DOM还没渲染时给未渲染的DOM原生绑定事件</li> <li>Component.js //类组件的父类,实现state,setState，接收props</li> <li>createElement.js //将craeteElement创建的节点映射为type,children格式的可递归的JS对象，通过递归渲染DOM原生.</li> <li>createReactUnit.js //核心文件，渲染React的各种组件，类组件，函数组件，以及数字和字符串
<br></li> <li>webpack入口文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./src/react'</span><span class="token punctuation">;</span><span class="token comment">//导入自己的react文件夹入口文件</span>

<span class="token keyword">var</span> <span class="token function-variable function">functionTest</span> <span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> name<span class="token operator">=</span><span class="token string">'FunctionTEST name'</span>
  <span class="token keyword">return</span>  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> name
    <span class="token punctuation">}</span><span class="token punctuation">,</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//调用自己的React对象下的基础方法渲染节点</span>
<span class="token keyword">let</span> TestNode <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;CJ&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token operator">:</span><span class="token string">'color:red'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;TEST2&quot;</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'spanCJ'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">onclick</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'我是span标签'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//渲染类组件</span>
<span class="token keyword">class</span> <span class="token class-name">TestClass</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span><span class="token string">'stateCJ'</span><span class="token punctuation">,</span>
      userList<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'CJ'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'CJ2'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      count<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillDidmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件渲染完成'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件开始渲染'</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
  <span class="token function">handleChangeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span><span class="token string">'StateChangeCJ'</span><span class="token punctuation">,</span>
      count<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Test组件render函数渲染'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> name
    <span class="token punctuation">}</span><span class="token punctuation">,</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">count:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Props:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token string">'点击触发setState'</span><span class="token punctuation">,</span>type<span class="token operator">:</span><span class="token string">'button'</span><span class="token punctuation">,</span><span class="token function-variable function">onclick</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChangeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>TestNode<span class="token punctuation">)</span><span class="token comment">//类组件render()函数再次渲染虚拟DOM对象</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//入口组件，渲染TestClass,babel打包前就是(&lt;TestClass name=&quot;CJPROPS&quot;/&gt;)</span>
<span class="token keyword">const</span> App<span class="token operator">=</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>TestClass<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;CJPROPS&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//调用我们自己写的React的render方法</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看完上述的组件代码，懂一点React的都应该能直到运行的结果是什么了吧，展示this.state对象内的name和count以及传递的props的name属性，点击按钮触发事件执行this.setState()去触发视图更新，每次点击count+1,以及修改name的值，并且在组件执行的生命周期执行各自的方法打印对应的值。我们来实现一下和react相同语法的功能。</p> <ul><li>index.js(react入口文件)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> createElement <span class="token keyword">from</span> <span class="token string">'./createElement'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Component <span class="token keyword">from</span> <span class="token string">'./Component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> createReactUnit <span class="token keyword">from</span> <span class="token string">'./createReactUnit'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> React<span class="token operator">=</span><span class="token punctuation">{</span><span class="token comment">//组装React对象，挂载对应方法和属性</span>
    Component<span class="token operator">:</span>Component<span class="token punctuation">,</span>
    createElement<span class="token operator">:</span>createElement<span class="token punctuation">,</span>
    nextRootIndex<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token comment">//事件委托，为每一个节点赋值一个唯一的节点标记的起始值，委托给documeny.body</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span>el</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//render函数,传递组件和挂载的节点</span>
        <span class="token keyword">let</span> createReactUnitInstance<span class="token operator">=</span><span class="token function">createReactUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//创建react单元实例</span>
        <span class="token keyword">let</span> markUp<span class="token operator">=</span>createReactUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span>nextRootIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取到单元实例上渲染的元素</span>
				el<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span>markUp<span class="token punctuation">;</span><span class="token comment">//挂载元素</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span>
</code></pre></div><ul><li>createReactUnit.js 重头戏，根据传递的对象类型渲染对应的组件或者字符,执行生命周期函数，render的第一个参数可能是类组件，也可能是函数组件，也可能是数字或者字符串，根据传递的对象进行判断。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> addEvent <span class="token keyword">from</span> <span class="token string">'./addEvent'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">ReactUnit</span> <span class="token punctuation">{</span>
	<span class="token comment">//React节点的祖先类，传递一个element对象，为每个继承自该组件的子类自动添加element对象</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>element <span class="token operator">=</span> element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ReactTextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">ReactUnit</span> <span class="token punctuation">{</span><span class="token comment">//渲染数字或者字符串节点,没什么可讲的</span>
		<span class="token comment">//省略constructor，es6类组件默认执行父类的constructor</span>
    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">rootId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_rootId <span class="token operator">=</span> rootId<span class="token punctuation">;</span>
        <span class="token keyword">let</span> markUp <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span data-react-id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rootId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> markUp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ReactNativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">ReactUnit</span> <span class="token punctuation">{</span>
		<span class="token comment">//省略constructor，es6类组件默认执行父类的constructor</span>
	<span class="token comment">//渲染虚拟DOM对象</span>
    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">rootId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_rootId <span class="token operator">=</span> rootId<span class="token punctuation">;</span>
				<span class="token comment">//获取根节点，为每个子节点添加序号，保证节点的序列号唯一性</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>
            type<span class="token punctuation">,</span>
            props
        <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">;</span>
				<span class="token comment">//该element是createElement返回的对象，格式</span>
				<span class="token comment">// {type:'div',props:{name:'CJ',childrend:[]}}，使用原生react打印下节点试试</span>
				<span class="token comment">//获取到节点的type，可以为div,p或者类或者函数</span>
				<span class="token comment">//props为节点传递的参数,如{click:xxx}</span>
        <span class="token keyword">let</span> attrsString <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
            content <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token comment">//初始化props和content，转换string输出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">'children'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">//遍历非子节点，设置props属性，即dom的attributes</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">//仅渲染点击事件，有时间添加其他事件</span>
                        <span class="token keyword">case</span> <span class="token string">'onclick'</span><span class="token operator">:</span>
							<span class="token comment">//用事件委托预添加事件，此时DOM并没有生成，所以无法添加事件</span>
							<span class="token comment">//传递唯一的索引rootId，事件类型和需要触发的事件</span>
							<span class="token comment">//使用事件委托也大大提高的浏览器的性能</span>
                            <span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rootId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">default</span><span class="token operator">:</span>
							<span class="token comment">//否则就是普通的props，直接渲染attributes</span>
                        attrsString <span class="token operator">+=</span> <span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果props中有children，就是子节点属性</span>
                    props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token comment">//遍历子节点，循环拼接html属性</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'string'</span><span class="token operator">||</span><span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">//简单类型直接渲染</span>
                            content <span class="token operator">+=</span> element<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type<span class="token operator">===</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token comment">//发现该节点类型为虚拟DOMM赋值给变量类型</span>
                                content <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token class-name">ReactNativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rootId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//childrend的子项type为虚拟节点变量时，</span>
					<span class="token comment">//再次递归调用渲染虚拟节点的方法渲染element.type，返回渲染后的html元素</span>
					<span class="token comment">//并传递唯一的rootId，在原基础上加上自己的循环索引</span>
                            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                                content <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token class-name">ReactNativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rootId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//否则就时普通的节点，如数字或者字符串，递归渲染element</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
				<span class="token comment">//开始标签和attributes</span>
        <span class="token keyword">let</span> startTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">  react-unid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rootId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attrsString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> endTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><span class="token comment">//结束标签</span>
				<span class="token comment">//content为递归渲染所有子节点后的文本内容</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>startTag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>endTag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ReactClassUnit</span> <span class="token keyword">extends</span> <span class="token class-name">ReactUnit</span><span class="token punctuation">{</span>
	<span class="token comment">//省略constructor，es6类组件默认执行父类的constructor</span>
	<span class="token comment">//渲染react类组件</span>
    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">rootId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_rootId<span class="token operator">=</span>rootId<span class="token punctuation">;</span>
				<span class="token comment">//同理，渲染唯一的reactunid</span>
        <span class="token keyword">let</span> reactInstance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>element<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//实例化类实例</span>
        reactInstance<span class="token punctuation">.</span>componentWillDidmount<span class="token operator">&amp;&amp;</span>reactInstance<span class="token punctuation">.</span><span class="token function">componentWillDidmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//执行生命周期钩子,实例化后到渲染前期间</span>
        <span class="token keyword">let</span> markup<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">.</span>type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">forchUpdates</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> el<span class="token operator">=</span>reactInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">//执行执行实例化后的render()函数返回的createElement对象</span>
            <span class="token keyword">let</span> reactClassUnitInstance<span class="token operator">=</span> <span class="token function">createReactUnit</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">//创建react单元函数，根据reactElemenet返回的对象调用对应的React单元</span>
						<span class="token comment">//判断是函数组件还是类组件和虚拟DOM</span>
            markup<span class="token operator">=</span>reactClassUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>rootId<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">//reactClassUnitInstance.getmarkup返回渲染的innerhtml元素</span>
            reactInstance<span class="token punctuation">.</span>el<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span>markup<span class="token punctuation">;</span><span class="token comment">//渲染到节点上去</span>
            <span class="token keyword">return</span> markup
        <span class="token punctuation">}</span>
	<span class="token comment">//对象原型上添加forceUpdates方法，强制视图刷新，即再次调用实例化后的render()函数</span>
        reactInstance<span class="token punctuation">.</span><span class="token function">forchUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reactInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>reactInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//渲染完执行生命周期钩子</span>
				 <span class="token keyword">return</span> markup；
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createReactUnit</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>el2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//创建React单元对象</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> el<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//进渲染变量</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactTextUnit</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">===</span><span class="token string">'object'</span><span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> el<span class="token punctuation">.</span>type<span class="token operator">===</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//类组件</span>
        el<span class="token punctuation">.</span>type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>el<span class="token operator">=</span>el2<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactClassUnit</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span><span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> el<span class="token punctuation">.</span>type<span class="token operator">===</span><span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//渲染虚拟DOM</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactNativeUnit</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> createReactUnit<span class="token punctuation">;</span>
</code></pre></div><ul><li>addEvent.js:简单的事件委托机制</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> observe<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//实例化一个发布订阅模式</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token parameter">reactUnid<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//给发布订阅添加一个发布</span>
    observe<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>reactUnid<span class="token punctuation">,</span>fn<span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//事件委托给全局的body对象，根据target的触发源去判定有没有事件执行</span>
	<span class="token comment">//其他事件类型同理</span>
        <span class="token keyword">let</span> enUnid<span class="token operator">=</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'react-unid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//得到触发源的react-unid</span>
        observe<span class="token punctuation">.</span><span class="token function">isPublish</span><span class="token punctuation">(</span>enUnid<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>observe<span class="token punctuation">.</span><span class="token function">fireSingle</span><span class="token punctuation">(</span>enUnid<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//在发布订阅中查看是否有订阅，有的话就执行该方法</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Observe</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//实例化发布订阅存储器</span>
    <span class="token punctuation">}</span>
    <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">=</span>fn<span class="token punctuation">;</span>
				<span class="token comment">//添加事件和key，使用对象确保唯一性</span>
    <span class="token punctuation">}</span>
    <span class="token function">isPublish</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token comment">//返回是否有订阅者</span>
    <span class="token punctuation">}</span>
    <span class="token function">fireSingle</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//触发订阅者</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">===</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">fireAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//触发所有订阅者</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fnCenter<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
              element<span class="token operator">&amp;&amp;</span><span class="token function">element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>createElement.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Element</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span>props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token operator">=</span>type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token operator">=</span>props<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span>attrs<span class="token punctuation">,</span><span class="token operator">...</span>children</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//就是把createElement形式的元素变换为{type,props}格式,props内放置children</span>
	<span class="token comment">//方便各种reactUnit递归遍历</span>
    <span class="token keyword">let</span> props <span class="token operator">=</span>attrs <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span>children<span class="token operator">=</span>children<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Component.js 提供一些基本的功能，如接收props，setState重新渲染等</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//传给子类接收props</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token operator">=</span>props<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//初始化子类state</span>
    <span class="token punctuation">}</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">patch</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token punctuation">{</span><span class="token comment">//合并state</span>
            <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span>
            <span class="token operator">...</span>patch
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'重置状态'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forchUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新最新的状态</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="实现效果预览"><a href="#实现效果预览" class="header-anchor">#</a> 实现效果预览</h2> <p>实现出来还是很自豪的，前端路上又艰难的前进了一小步
<img src="./../imgs/react.gif"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FrameWorkBase/MVVM.html" class="prev">MVVM响应式原理</a></span> <span class="next"><a href="/FrameWorkBase/VisualDom.html">虚拟DOM</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1ae9d9f8.js" defer></script><script src="/assets/js/2.854a77d5.js" defer></script><script src="/assets/js/24.895485da.js" defer></script>
  </body>
</html>
