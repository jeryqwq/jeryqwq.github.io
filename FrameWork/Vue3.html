<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3 | BlogMan</title>
    <meta name="description" content="曾今我也以为梦想遥不可及">
    
    
    <link rel="preload" href="/assets/css/0.styles.f080e4e2.css" as="style"><link rel="preload" href="/assets/js/app.fb2d74ba.js" as="script"><link rel="preload" href="/assets/js/25.aaf68fd5.js" as="script"><link rel="prefetch" href="/assets/js/10.d56ecd25.js"><link rel="prefetch" href="/assets/js/11.e272b5ad.js"><link rel="prefetch" href="/assets/js/12.68c84184.js"><link rel="prefetch" href="/assets/js/13.9f981e84.js"><link rel="prefetch" href="/assets/js/14.795f87e7.js"><link rel="prefetch" href="/assets/js/15.bf9c2ac0.js"><link rel="prefetch" href="/assets/js/16.bc2eb76e.js"><link rel="prefetch" href="/assets/js/17.faf54124.js"><link rel="prefetch" href="/assets/js/18.cce734c0.js"><link rel="prefetch" href="/assets/js/19.f9b18e5a.js"><link rel="prefetch" href="/assets/js/2.b2af8c76.js"><link rel="prefetch" href="/assets/js/20.85d486de.js"><link rel="prefetch" href="/assets/js/21.bf476d49.js"><link rel="prefetch" href="/assets/js/22.cc54ab8a.js"><link rel="prefetch" href="/assets/js/23.6a4e0590.js"><link rel="prefetch" href="/assets/js/24.f8d62769.js"><link rel="prefetch" href="/assets/js/26.19ee1cb6.js"><link rel="prefetch" href="/assets/js/27.81c19989.js"><link rel="prefetch" href="/assets/js/28.e4513c0f.js"><link rel="prefetch" href="/assets/js/29.454573ad.js"><link rel="prefetch" href="/assets/js/3.8c427b61.js"><link rel="prefetch" href="/assets/js/30.671efada.js"><link rel="prefetch" href="/assets/js/31.7d49fb7b.js"><link rel="prefetch" href="/assets/js/32.26467649.js"><link rel="prefetch" href="/assets/js/33.cc1e895b.js"><link rel="prefetch" href="/assets/js/34.4d1df63c.js"><link rel="prefetch" href="/assets/js/35.da2058d5.js"><link rel="prefetch" href="/assets/js/36.de1614db.js"><link rel="prefetch" href="/assets/js/4.29a55889.js"><link rel="prefetch" href="/assets/js/5.d1e838c0.js"><link rel="prefetch" href="/assets/js/6.e4259f87.js"><link rel="prefetch" href="/assets/js/7.33155155.js"><link rel="prefetch" href="/assets/js/8.c60c6b33.js"><link rel="prefetch" href="/assets/js/9.b7957b3c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f080e4e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">BlogMan</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">前端</a></div><div class="nav-item"><a href="/nav/Time.html" class="nav-link">时间安排</a></div><div class="nav-item"><a href="/nav/Reading.html" class="nav-link">阅读</a></div><div class="nav-item"><a href="/nav/MY.html" class="nav-link">作品</a></div><div class="nav-item"><a href="https://github.com/jeryqwq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">前端</a></div><div class="nav-item"><a href="/nav/Time.html" class="nav-link">时间安排</a></div><div class="nav-item"><a href="/nav/Reading.html" class="nav-link">阅读</a></div><div class="nav-item"><a href="/nav/MY.html" class="nav-link">作品</a></div><div class="nav-item"><a href="https://github.com/jeryqwq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JS深入系列</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架必知</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>框架</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/FrameWork/Typescript.html" class="sidebar-link">Typescript</a></li><li><a href="/FrameWork/Vue.html" class="sidebar-link">Vue进阶</a></li><li><a href="/FrameWork/Vue3.html" class="active sidebar-link">Vue3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FrameWork/Vue3.html#关于vue3" class="sidebar-link">关于Vue3</a></li><li class="sidebar-sub-header"><a href="/FrameWork/Vue3.html#核心api" class="sidebar-link">核心API</a></li><li class="sidebar-sub-header"><a href="/FrameWork/Vue3.html#核心原理及实现" class="sidebar-link">核心原理及实现</a></li></ul></li><li><a href="/FrameWork/React.html" class="sidebar-link">React</a></li><li><a href="/FrameWork/Koa.html" class="sidebar-link">Koa</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端大杂烩</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="关于vue3"><a href="#关于vue3" aria-hidden="true" class="header-anchor">#</a> 关于Vue3</h2> <p>Vue3与10月6号左右宣布即将发布，作者也公开了底层的基于proxy语法重新构建的vue3新版本，大量使用了typescript去构建，rollup打包，风格也借鉴了react 16.8版本的hooks，相当于vue3中没有了this对象(use,mixin等基于this的API可能有改变,router和vuex也将基于inject,providAPI重写--猜测)，底层响应式原理重写(delete,set等由于defineprototypeAPI的缺点产生的API也将没有)，Vue3相关的API可以看这里<a href="https://vue-composition-api-rfc.netlify.com/api.html#setup" target="_blank" rel="noopener noreferrer">Vue Composition API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>目前还没出中文版本，熟悉react hooks的可直接上手</p> <h2 id="核心api"><a href="#核心api" aria-hidden="true" class="header-anchor">#</a> 核心API</h2> <h4 id="reactive"><a href="#reactive" aria-hidden="true" class="header-anchor">#</a> reactive</h4> <p>响应式核心，相关核心API依赖，使用proxy代理对象并返回proxy，相当于Vue2的definePropertyAPI，避免了数组的缺陷，可劫持数据的所有操作，具体查看相关API文档</p> <h4 id="effect"><a href="#effect" aria-hidden="true" class="header-anchor">#</a> effect</h4> <p>与react的useEffect用法相识，当前先触发一次，之后对数据的更改都会执行该函数，仅对所传递的函数内有响应式的数据生效，且只有函数内的变量状态改变才触发，依赖收集很巧妙的利用JS单线程的特点，极大程度上自动优化了框架性能，使用者不必太关心性能问题。</p> <h4 id="运行"><a href="#运行" aria-hidden="true" class="header-anchor">#</a> 运行</h4> <p>打包一份vue3的代码，试试效果</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./vue.global.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- vue仓库打包的代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">let</span> obj1<span class="token operator">=</span><span class="token punctuation">{</span>
            name<span class="token punctuation">:</span><span class="token string">'CJ'</span><span class="token punctuation">,</span>
            age<span class="token punctuation">:</span><span class="token number">23</span>
        <span class="token punctuation">}</span><span class="token comment">//原对象</span>
        <span class="token keyword">let</span> p1<span class="token operator">=</span>Vue<span class="token punctuation">.</span><span class="token function">reactive</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回代理后的proxy对象</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Proxy{name:&quot;CJ}</span>
        Vue<span class="token punctuation">.</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//影响：当p1的name属性发生改变时触发函数执行，仅仅只有name属性更改触发</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect1:name改变&quot;</span><span class="token operator">+</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//立即执行一次 打印effect1:name改变CJ</span>

        Vue<span class="token punctuation">.</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//同上</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect2:name改变&quot;</span><span class="token operator">+</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//立即执行一次 打印effect2:name改变CJ</span>
        Vue<span class="token punctuation">.</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//影响：当p1的age属性发生改变时触发函数执行，仅仅只有age属性更改触发</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect1:age改变&quot;</span><span class="token operator">+</span>p1<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//立即执行一次 打印effect1:age改变23</span>
        Vue<span class="token punctuation">.</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//同上</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect2:age改变&quot;</span><span class="token operator">+</span>p1<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//立即执行一次  打印effect2:age改变23</span>

        p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI@&quot;</span><span class="token punctuation">;</span><span class="token comment">//name属性有两个effect函数，所以执行两次</span>
        <span class="token comment">// effect1:name改变CJI@</span>
        <span class="token comment">// effect2:name改变CJI@</span>
        p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI1&quot;</span><span class="token punctuation">;</span><span class="token comment">//同理</span>
        <span class="token comment">// effect1:name改变CJI1</span>
        <span class="token comment">// effect2:name改变CJI1</span>
        p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI2&quot;</span><span class="token punctuation">;</span><span class="token comment">//同理</span>
        p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI3&quot;</span><span class="token punctuation">;</span><span class="token comment">//同理</span>
        p1<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">;</span><span class="token comment">//age更改也有两个effect，也是两次。</span>
         <span class="token comment">// 控制台结果</span>
        <span class="token comment">// effect1:age改变24</span>
        <span class="token comment">// effect2:age改变24</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>开始感觉真的很奇怪，vue3是如何做到effect内的函数仅因为自己函数内有的变量改动才会触发执行，感觉好神奇，如何优化能做到这样？</p> <h2 id="核心原理及实现"><a href="#核心原理及实现" aria-hidden="true" class="header-anchor">#</a> 核心原理及实现</h2> <p>使用typescript构建，刚学，比较菜，就当原生JS看就好了</p> <h3 id="reactive-ts"><a href="#reactive-ts" aria-hidden="true" class="header-anchor">#</a> reactive.ts</h3> <p>源码路径：vue-next\packages\reactivity\src\reactive.ts</p> <p>将数据转换为响应式，使用proxy代理对应的target，劫持对应的get，set，weakMap做代理映射表，基于其弱引用的特性，key只能为Object类型，对象不存在时GC自动回收其value，性能优化。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> <span class="token punctuation">{</span>track<span class="token punctuation">,</span>trigger<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'./track'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//触发器和收集依赖</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>proxyConstructor<span class="token punctuation">,</span>Handle<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./interface'</span><span class="token punctuation">;</span><span class="token comment">//ts接口，类型约束handler和proxy</span>
<span class="token keyword">let</span> toProxy<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存储代理对象弱引用，key只能为非简单类型，key为空时方便GC机制回收对用的value</span>
<span class="token keyword">let</span> toRaw<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//防止重复代理已经代理过的proxy对象做缓存检查</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span><span class="token builtin">any</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//就是想和源码一样的调用过程而已</span>
    <span class="token keyword">return</span> <span class="token function">createReactiveObj</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> handle<span class="token punctuation">:</span>Handle<span class="token operator">=</span><span class="token punctuation">{</span><span class="token comment">//proxy处理函数，new proxy传入处理器，建议先跳到createReactiveObj方法</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token comment">//effect内包裹的函数每次先执行都会获取内部被劫持变量</span>
        <span class="token comment">//触发对应的get，执行依赖收集</span>
        <span class="token keyword">const</span> res<span class="token operator">=</span>Reflect<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Reflect能返回操作是否成功</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> res<span class="token punctuation">:</span><span class="token builtin">boolean</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> oldVal<span class="token operator">=</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//没有属性为新增</span>
        <span class="token comment">//防止劫持对象为数组时触发两次set避免不必要的更新</span>
        <span class="token comment">//第一次改变为设置该数组的下标，如果是删除或者新增是则会触发该数组第项的length对象的改变</span>
            <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span><span class="token string">'add'</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通知触发器执行对应的依赖</span>
            res<span class="token operator">=</span>Reflect<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使用reflect能够返回操作是否成功</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>oldVal<span class="token operator">!==</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//对象已有改属性代表修改</span>
            res<span class="token operator">=</span>Reflect<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span><span class="token string">'update'</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通知触发器执行对应的依赖</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//代理监测</span>
<span class="token keyword">function</span> createReactiveObj<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span> <span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span><span class="token constant">T</span><span class="token operator">|</span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">:</span>proxyConstructor<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> target<span class="token operator">===</span><span class="token string">'object'</span><span class="token operator">||</span>target<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//type of null ===object===true</span>
        <span class="token keyword">const</span> targetProxy<span class="token operator">=</span>toProxy<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token comment">//代理映射表弱引用，查看是否以及被代理过</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>targetProxy<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//防止代理重复的代理对象</span>
            <span class="token keyword">return</span> targetProxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>toRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//反向映射表防止传入多次代理已代理过的对象</span>
            <span class="token keyword">return</span> target
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> observe<span class="token punctuation">:</span>proxyConstructor<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        toProxy<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>observe<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加代理映射表</span>
        toRaw<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>observe<span class="token punctuation">,</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加反向代理映射表</span>
        <span class="token keyword">return</span> observe<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="track-ts"><a href="#track-ts" aria-hidden="true" class="header-anchor">#</a> track.ts</h4> <p>effect函数收集监听对象effect里target对应的函数，利用执行函数时会访问到函数内监听对象的值，触发handler的get，执行收集依赖，相同的key放入同一个set集合,改变时在set函数内触发对应key的set集合的函数依次执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span>effectStacks<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./effect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存储effect函数的栈接口数组</span>
<span class="token keyword">let</span> targetMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//收集依赖</span>
    <span class="token keyword">let</span> effect<span class="token operator">=</span>effectStacks<span class="token punctuation">[</span>effectStacks<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//得到effect内的函数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> depsMap<span class="token operator">=</span>targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查看是否有该对象map</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//没有则新建对应target的map对象</span>
            targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>depsMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> deps<span class="token operator">=</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到该map下的所收集的set集合的依赖</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//没有则新建空set</span>
            depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>deps<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//没有effect则添加</span>
            deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token comment">//函数执行一遍后targetMap内的结构就应该是这样的解构</span>
<span class="token comment">// {</span>
<span class="token comment">//     target:{</span>
<span class="token comment">//         key:[effect1,effect2,effect3]//,</span>
<span class="token comment">//         key:[effect1]</span>
<span class="token comment">//     },</span>
<span class="token comment">//     target2:{</span>
<span class="token comment">//         key:[effect1,effect2,effect3]//,</span>
<span class="token comment">//         key:[effect1]</span>
<span class="token comment">//     }</span>
<span class="token comment">// }</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>type<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//触发依赖执行</span>
    <span class="token keyword">let</span> depsMap<span class="token operator">=</span>targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取对象下的map</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token comment">//有map的话就代表该map下有set集合的effect函数</span>
        <span class="token keyword">let</span> deps<span class="token operator">=</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//是否有该key的effect set集合</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//有就遍历整个set对象执行对应的effect内的函数</span>
            deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="effect-ts"><a href="#effect-ts" aria-hidden="true" class="header-anchor">#</a> effect.ts</h4> <p>存储effect栈数组，每次effect函数调用时都会往effect栈数组推入依赖的函数，然后执行一次effect内包裹的函数去触发proxy的get，再去触发收集依赖，以特定的格式收集存储该依赖，执行完毕后移除push的effect函数。</p> <div class="language-ts extra-class"><pre class="language-ts"><code> <span class="token keyword">let</span> effectStacks<span class="token punctuation">:</span><span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">&gt;=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">function</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">:</span><span class="token builtin">Function</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">:</span><span class="token builtin">Function</span><span class="token punctuation">,</span>fn<span class="token punctuation">:</span><span class="token builtin">Function</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        effectStacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//effect栈推入effect函数</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//首次调用，执行一次，触发get函数内的track收集依赖，此时的栈内已有effect函数。</span>
        <span class="token comment">//track会将该函数已特定的形式存储起来</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        effectStacks<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除push的effect，等待下次effect调用该函数，再次重新执行</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
 <span class="token keyword">function</span> <span class="token function">effect</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">:</span><span class="token builtin">Function</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
    effectStacks<span class="token punctuation">,</span>
    effect
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="效果"><a href="#效果" aria-hidden="true" class="header-anchor">#</a> 效果</h3> <p>因为环境是ts构建，所以使用node去执行对应的代码</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>reactive<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactive'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>effect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj1<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'CJ'</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> p1<span class="token operator">=</span><span class="token function">reactive</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect1:&quot;</span><span class="token operator">+</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;effect2:&quot;</span><span class="token operator">+</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI@&quot;</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI1&quot;</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI2&quot;</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">&quot;CJI3&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//输出顺序</span>
<span class="token comment">// effect1:CJ name effect1 首次执行</span>
<span class="token comment">// effect2:CJ name effect2首次执行</span>
<span class="token comment">// effect1:CJI@  name  effect1 修改触发</span>
<span class="token comment">// effect2:CJI@  name  effect2 修改触发</span>
<span class="token comment">// effect1:CJI1   name  effect1 修改触发</span>
<span class="token comment">// effect2:CJI1</span>
<span class="token comment">// effect1:CJI2</span>
<span class="token comment">// effect2:CJI2</span>
<span class="token comment">// effect1:CJI3</span>
<span class="token comment">// effect2:CJI3</span>


</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/FrameWork/Vue.html" class="prev">
          Vue进阶
        </a></span> <span class="next"><a href="/FrameWork/React.html">
          React
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.fb2d74ba.js" defer></script><script src="/assets/js/25.aaf68fd5.js" defer></script>
  </body>
</html>
